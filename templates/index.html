<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>üìÅ Folder Tree Viewer</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: false });
    window.mermaid = mermaid;
    </script>

    
    </head>
    <body>

    <h2>üìÅ Folder Tree to Mermaid Diagram</h2>

    <div>
        <input type="text" id="folderPath" placeholder="Enter full folder path (e.g. C:\\Users\\Grace\\MyProject)" />
        <select id="layout">
            <option value="TD">Top ‚Üí Down (TD)</option>
            <option value="LR">Left ‚Üí Right (LR)</option>
            <option value="BT">Bottom ‚Üí Top (BT)</option>
            <option value="RL">Right ‚Üí Left (RL)</option>
        </select>
        <button onclick="fetchTree()">Generate</button>
        <button onclick="downloadDiagram()">‚¨áÔ∏è Download</button>
    </div>

    <div style="margin-top: 1rem;">
        <button onclick="zoom('in')">‚ûï Zoom In</button>
        <button onclick="zoom('out')">‚ûñ Zoom Out</button>
        <button onclick="zoom('reset')">üîÑ Reset Zoom</button>
    </div>

    <div class="diagram-wrapper zoom-container" id="zoom-container">
        <div id="diagram" class="mermaid"></div>
    </div>

    <script>
        let zoomLevel = 1;

        function fetchTree() {
        const path = document.getElementById('folderPath').value.trim();
        const layout = document.getElementById('layout').value;
        if (!path) return;

        fetch('/get-tree', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path })
        })
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('zoom-container');
            const oldDiagram = document.getElementById('diagram');
            oldDiagram.remove();

            const newDiv = document.createElement("div");
            newDiv.className = "mermaid";
            newDiv.id = "diagram";

            if (data.error) {
            newDiv.textContent = `graph ${layout}\n  A["‚ùå ${data.error}"]`;
            container.appendChild(newDiv);
            window.mermaid.run();
            return;
            }

            if (data.tree.length > 1000) {
            alert("‚ö†Ô∏è Folder too large to render. Try a smaller one or reduce depth.");
            return;
            }

            const tree = data.tree.slice(0, 300); // keep it safe
            const mermaidText = convertToMermaid(tree, layout);
            newDiv.textContent = mermaidText;
            container.appendChild(newDiv);
            window.mermaid.run();
        })
        .catch(err => {
            console.error(err);
            const diagram = document.getElementById('diagram');
            diagram.textContent = 'graph TD\n  A["‚ùå Error contacting server"]';
            window.mermaid.run();
        });
        }

        function convertToMermaid(lines, layout = "TD") {
        const stack = [];
        const edges = [];
        const labels = {};

        lines.forEach(line => {
            const level = (line.match(/‚îÇ   |    /g) || []).length;
            const raw = line.replace(/^[‚îÇ\s‚îú‚îî‚îÄ]+/, '');
            const safe = raw.replace(/[^\w\-\.]/g, '_') + "_" + Math.random().toString(36).substring(2, 5);
            labels[safe] = raw;

            while (stack.length > level) stack.pop();
            const parent = stack[stack.length - 1];
            if (parent) edges.push(`${parent} --> ${safe}`);
            stack[level] = safe;
        });

        let mermaid = `graph ${layout}\n`;
        Object.entries(labels).forEach(([id, label]) => {
            mermaid += `  ${id}["${label}"]\n`;
        });
        edges.forEach(edge => {
            mermaid += `  ${edge}\n`;
        });

        return mermaid;
        }

        function downloadDiagram() {
        const svg = document.querySelector(".mermaid svg");
        if (!svg) return alert("Please generate the diagram first.");

        const blob = new Blob([svg.outerHTML], { type: "image/svg+xml" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "folder-tree.svg";
        a.click();

        URL.revokeObjectURL(url);
        }

        function zoom(direction) {
        const container = document.getElementById("zoom-container");
        if (direction === "in") {
            zoomLevel += 0.1;
        } else if (direction === "out") {
            zoomLevel = Math.max(0.1, zoomLevel - 0.1);
        } else if (direction === "reset") {
            zoomLevel = 1;
        }
        container.style.transform = `scale(${zoomLevel})`;
        }

        // Ctrl + mouse wheel zoom
        document.addEventListener('wheel', function (e) {
        if (e.ctrlKey || e.metaKey) {
            e.preventDefault();
            if (e.deltaY < 0) {
            zoom('in');
            } else {
            zoom('out');
            }
        }
        }, { passive: false });
    </script>
</body>
</html>
